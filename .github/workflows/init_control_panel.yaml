name: Init Control Plane


on:
  workflow_run:
    workflows: ["Provision Infrastructure"]
    types:
      - completed
jobs:
  init_control_plane:
    name: Initialize Kubernetes Control Plane
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-west-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ðŸ§ª Terraform Init & Get Control Plane IP
        working-directory: tf
        run: |
          terraform init -input=false
          echo "âœ… Terraform initialized"

          echo "ðŸ” Available outputs:"
          terraform output || echo "âŒ No outputs found"

          CONTROL_PLANE_IP=$(terraform output -raw control_plane_ip 2>/dev/null || echo "")
          echo "$CONTROL_PLANE_IP" > ip.txt

          if [ -z "$CONTROL_PLANE_IP" ]; then
            echo "âŒ control_plane_ip output is empty. Did you run terraform apply yet?"
            exit 1
          fi

          echo "âœ… Control Plane IP: $CONTROL_PLANE_IP"

      - name: ðŸ”‘ Save EC2 SSH Private Key
        working-directory: tf
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: ðŸš€ Copy & Run Init Script on Control Plane
        working-directory: tf
        run: |
          CONTROL_PLANE_IP=$(cat ip.txt | tr -d '\r\n')

          echo "ðŸ”§ Initializing cluster at $CONTROL_PLANE_IP"

          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no init-control-plane.sh "ubuntu@$CONTROL_PLANE_IP:~/init-control-plane.sh"

          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "ubuntu@$CONTROL_PLANE_IP" "
            chmod +x ~/init-control-plane.sh
            bash ~/init-control-plane.sh
          "
